<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-center-atom.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"jasonfoev.github.io","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"hide","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="v5cs (stands for “version 5 control system”) is a newly designed control system for the model rocket.">
<meta property="og:type" content="article">
<meta property="og:title" content="Model rocket control system update (version 5)">
<meta property="og:url" content="https://jasonfoev.github.io/2024/04/13/Model-rocket-control-system-update-version-5/index.html">
<meta property="og:site_name" content="FOEV&#39;s blog site">
<meta property="og:description" content="v5cs (stands for “version 5 control system”) is a newly designed control system for the model rocket.">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://jasonfoev.github.io/2024/04/13/Model-rocket-control-system-update-version-5/v5cs&parachute.png">
<meta property="og:image" content="https://jasonfoev.github.io/2024/04/13/Model-rocket-control-system-update-version-5/v5csupper&lower.png">
<meta property="og:image" content="https://jasonfoev.github.io/2024/04/13/Model-rocket-control-system-update-version-5/v5csassembly.png">
<meta property="article:published_time" content="2024-04-13T00:53:26.000Z">
<meta property="article:modified_time" content="2024-10-31T17:09:22.774Z">
<meta property="article:author" content="FOEV">
<meta property="article:tag" content="Rocketry">
<meta property="article:tag" content="My Projects">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://jasonfoev.github.io/2024/04/13/Model-rocket-control-system-update-version-5/v5cs&parachute.png">

<link rel="canonical" href="https://jasonfoev.github.io/2024/04/13/Model-rocket-control-system-update-version-5/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>Model rocket control system update (version 5) | FOEV's blog site</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">FOEV's blog site</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://jasonfoev.github.io/2024/04/13/Model-rocket-control-system-update-version-5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="FOEV">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="FOEV's blog site">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Model rocket control system update (version 5)
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-04-13 08:53:26" itemprop="dateCreated datePublished" datetime="2024-04-13T08:53:26+08:00">2024-04-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-11-01 01:09:22" itemprop="dateModified" datetime="2024-11-01T01:09:22+08:00">2024-11-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/The-Control-Systems-Series/" itemprop="url" rel="index"><span itemprop="name">The Control Systems Series</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p><strong>v5cs</strong> (stands for “version 5 control system”) is a newly designed control system for the model rocket. <span id="more"></span> It is capable of calculating the orientation and height of the rocket amidst flight, and transmitting the data back to the ground station. When the rocket is detected to be tilting by over 60 degrees from vertical position, the servo will turn and release the parachute, which is retained in the nosecone by the servo arm, and can be deployed via a small piece of rubber band.</p>
<img src="v5cs&parachute.png" width="70%" height="50%" style="vertical-align:middle; margin:0px 120px" />
<center>Figure 1. v5cs and parachute bay (nosecone) stacked together</center>

<hr>
<div align="center">
<img src="v5csupper&lower.png" width="85%" height="50%" style="vertical-align:middle; margin:0px 50px" />
Figure 2. v5cs: upper face and lower face
</div>

<p>The servo is positioned at the upmost part of the entire system, and directly controls the release of parachute.<br>The cavity besides the servo is made to accomodate the 3.7v lithium battery.<br>A special opening is made at the lowest part of the entire sysem, which allows data transmittion &amp; (wired) debugging without needing to disassembly the bay.</p>
<hr>
<div align="center">
<img src="v5csassembly.png" width="85%" height="50%" style="vertical-align:middle; margin:0px 50px" />
Figure 3. v5cs: dissected parts
</div>

<p>The control system uses the lora 32 board as its main board. It is an upgraded version of the <em>Espressif esp 32</em> board by <em>Heltec Automation</em>, incoorporating the powerful wireless data transmission tool <em><strong>LORA</strong></em>.<br>The <em>bmp180</em> barometric sensor gives precise measurement of the air pressure.<br>The <em>mpu6050</em> gyroscope sensor gives precise measurement of the rocket’s current position.</p>
<hr>
<h1 id="Programming"><a href="#Programming" class="headerlink" title=" Programming "></a><center> Programming </center></h1><p><strong>Libraries used (in VS code):</strong></p>
<ul>
<li>Adafruit BMP085 Library</li>
<li>Adafruit BusIO</li>
<li>Adafruit GFX Library</li>
<li>Adafruit MPU6050</li>
<li>Adafruit SSD130</li>
<li>Adafruit Unified Sensor</li>
<li>ESP32Servo</li>
<li>MPU6050_tock</li>
<li>RadioLib</li>
</ul>
<p><strong>Code:</strong></p>
<details> 
<summary><font size="4" color="orange">Click here to view code</font></summary> 
<pre>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ESP32Servo.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Wire.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Adafruit_MPU6050.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Adafruit_BMP085.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Adafruit_Sensor.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;math.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;RadioLib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">Adafruit_MPU6050 mpu;</span><br><span class="line">Adafruit_BMP085 bmp;</span><br><span class="line">SX1262 radio = <span class="keyword">new</span> <span class="built_in">Module</span>(<span class="number">8</span>, <span class="number">14</span>, <span class="number">12</span>, <span class="number">13</span>);</span><br><span class="line">Servo myservo;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> servoPin = <span class="number">21</span>;</span><br><span class="line"><span class="type">int</span> pos = <span class="number">90</span>; <span class="comment">// 定義舵機轉動位置</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> transmissionState = RADIOLIB_ERR_NONE;</span><br><span class="line">  </span><br><span class="line"><span class="comment">// flag to indicate that a packet was sent</span></span><br><span class="line"><span class="keyword">volatile</span> <span class="type">bool</span> transmittedFlag = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// this function is called when a complete packet</span></span><br><span class="line"><span class="comment">// is transmitted by the module</span></span><br><span class="line"><span class="comment">// IMPORTANT: this function MUST be &#x27;void&#x27; type</span></span><br><span class="line"><span class="comment">//            and MUST NOT have any arguments!</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(ESP8266) || defined(ESP32)</span></span><br><span class="line">  ICACHE_RAM_ATTR</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setFlag</span><span class="params">(<span class="type">void</span>)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// we sent a packet, set the flag</span></span><br><span class="line">  transmittedFlag = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// counter to keep track of transmitted packets</span></span><br><span class="line"><span class="type">int</span> count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setup</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">delay</span>(<span class="number">5000</span>);</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> state = radio.<span class="built_in">begin</span>(<span class="number">433</span>);</span><br><span class="line">  <span class="keyword">if</span> (state == RADIOLIB_ERR_NONE) &#123;</span><br><span class="line">    Serial.<span class="built_in">println</span>(<span class="built_in">F</span>(<span class="string">&quot;Lora initialize success!&quot;</span>));</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    Serial.<span class="built_in">print</span>(<span class="built_in">F</span>(<span class="string">&quot;failed, code &quot;</span>));</span><br><span class="line">    Serial.<span class="built_in">println</span>(state);</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  radio.<span class="built_in">setPacketSentAction</span>(setFlag);</span><br><span class="line"></span><br><span class="line">  myservo.<span class="built_in">attach</span>(servoPin, <span class="number">500</span>, <span class="number">2500</span>); <span class="comment">// 設置舵機控制腳位，並設置最小與最大脈寬</span></span><br><span class="line">  <span class="keyword">while</span> (!mpu.<span class="built_in">begin</span>(<span class="number">0x68</span>))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">continue</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  Serial.<span class="built_in">begin</span>(<span class="number">115200</span>);                <span class="comment">// 設置序列埠鮑率</span></span><br><span class="line">  <span class="type">int</span> init_angle = myservo.<span class="built_in">read</span>();     <span class="comment">// 讀取舵機初始角度</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (init_angle != pos)</span><br><span class="line">  &#123;</span><br><span class="line">    myservo.<span class="built_in">write</span>(pos);</span><br><span class="line">    <span class="built_in">delay</span>(<span class="number">2000</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  Serial.<span class="built_in">println</span>(<span class="string">&quot;Servo initialize success!&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (!bmp.<span class="built_in">begin</span>(<span class="number">0x76</span>)) &#123;</span><br><span class="line">	  Serial.<span class="built_in">println</span>(<span class="string">&quot;Could not find a valid BMP085/BMP180 sensor, check wiring!&quot;</span>);</span><br><span class="line">    <span class="built_in">delay</span>(<span class="number">1000</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  Serial.<span class="built_in">println</span>(<span class="string">&quot;bmp initialize success!&quot;</span>);</span><br><span class="line">  <span class="keyword">while</span> (!mpu.<span class="built_in">begin</span>(<span class="number">0x68</span>)) &#123;</span><br><span class="line">	  Serial.<span class="built_in">println</span>(<span class="string">&quot;Could not find a valid BMP085/BMP180 sensor, check wiring!&quot;</span>);</span><br><span class="line">    <span class="built_in">delay</span>(<span class="number">1000</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  mpu.<span class="built_in">setAccelerometerRange</span>(MPU6050_RANGE_8_G);</span><br><span class="line">  Serial.<span class="built_in">print</span>(<span class="string">&quot;Accelerometer range set to: &quot;</span>);</span><br><span class="line">  <span class="keyword">switch</span> (mpu.<span class="built_in">getAccelerometerRange</span>()) &#123;</span><br><span class="line">  <span class="keyword">case</span> MPU6050_RANGE_2_G:</span><br><span class="line">    Serial.<span class="built_in">println</span>(<span class="string">&quot;+-2G&quot;</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> MPU6050_RANGE_4_G:</span><br><span class="line">    Serial.<span class="built_in">println</span>(<span class="string">&quot;+-4G&quot;</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> MPU6050_RANGE_8_G:</span><br><span class="line">    Serial.<span class="built_in">println</span>(<span class="string">&quot;+-8G&quot;</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> MPU6050_RANGE_16_G:</span><br><span class="line">    Serial.<span class="built_in">println</span>(<span class="string">&quot;+-16G&quot;</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  mpu.<span class="built_in">setGyroRange</span>(MPU6050_RANGE_500_DEG);</span><br><span class="line">  Serial.<span class="built_in">print</span>(<span class="string">&quot;Gyro range set to: &quot;</span>);</span><br><span class="line">  <span class="keyword">switch</span> (mpu.<span class="built_in">getGyroRange</span>()) &#123;</span><br><span class="line">  <span class="keyword">case</span> MPU6050_RANGE_250_DEG:</span><br><span class="line">    Serial.<span class="built_in">println</span>(<span class="string">&quot;+- 250 deg/s&quot;</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> MPU6050_RANGE_500_DEG:</span><br><span class="line">    Serial.<span class="built_in">println</span>(<span class="string">&quot;+- 500 deg/s&quot;</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> MPU6050_RANGE_1000_DEG:</span><br><span class="line">    Serial.<span class="built_in">println</span>(<span class="string">&quot;+- 1000 deg/s&quot;</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> MPU6050_RANGE_2000_DEG:</span><br><span class="line">    Serial.<span class="built_in">println</span>(<span class="string">&quot;+- 2000 deg/s&quot;</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  mpu.<span class="built_in">setFilterBandwidth</span>(MPU6050_BAND_5_HZ);</span><br><span class="line">  Serial.<span class="built_in">print</span>(<span class="string">&quot;Filter bandwidth set to: &quot;</span>);</span><br><span class="line">  <span class="keyword">switch</span> (mpu.<span class="built_in">getFilterBandwidth</span>()) &#123;</span><br><span class="line">  <span class="keyword">case</span> MPU6050_BAND_260_HZ:</span><br><span class="line">    Serial.<span class="built_in">println</span>(<span class="string">&quot;260 Hz&quot;</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> MPU6050_BAND_184_HZ:</span><br><span class="line">    Serial.<span class="built_in">println</span>(<span class="string">&quot;184 Hz&quot;</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> MPU6050_BAND_94_HZ:</span><br><span class="line">    Serial.<span class="built_in">println</span>(<span class="string">&quot;94 Hz&quot;</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> MPU6050_BAND_44_HZ:</span><br><span class="line">    Serial.<span class="built_in">println</span>(<span class="string">&quot;44 Hz&quot;</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> MPU6050_BAND_21_HZ:</span><br><span class="line">    Serial.<span class="built_in">println</span>(<span class="string">&quot;21 Hz&quot;</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> MPU6050_BAND_10_HZ:</span><br><span class="line">    Serial.<span class="built_in">println</span>(<span class="string">&quot;10 Hz&quot;</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> MPU6050_BAND_5_HZ:</span><br><span class="line">    Serial.<span class="built_in">println</span>(<span class="string">&quot;5 Hz&quot;</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  Serial.<span class="built_in">println</span>(<span class="string">&quot;mpu initialize success!&quot;</span>);</span><br><span class="line"></span><br><span class="line">  transmissionState = radio.<span class="built_in">startTransmit</span>(<span class="string">&quot;0&quot;</span>);</span><br><span class="line"></span><br><span class="line">  Serial.<span class="built_in">println</span>(<span class="string">&quot;modules initialized&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> Kp 100.0f                        <span class="comment">// 比例增益支配率收敛到加速度计/磁强计</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> Ki 0.002f                <span class="comment">// 积分增益支配率的陀螺仪偏见的衔接</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> halfT 0.001f                <span class="comment">// 采样周期的一半</span></span></span><br><span class="line"> </span><br><span class="line"><span class="type">float</span> q0 = <span class="number">1</span>, q1 = <span class="number">0</span>, q2 = <span class="number">0</span>, q3 = <span class="number">0</span>;          <span class="comment">// 四元数的元素，代表估计方向</span></span><br><span class="line"><span class="type">float</span> exInt = <span class="number">0</span>, eyInt = <span class="number">0</span>, ezInt = <span class="number">0</span>;        <span class="comment">// 按比例缩小积分误差</span></span><br><span class="line"> </span><br><span class="line"><span class="type">float</span> Yaw,Pitch,Roll;  <span class="comment">//偏航角，俯仰角，翻滚角</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">IMUupdate</span><span class="params">(<span class="type">float</span> gx, <span class="type">float</span> gy, <span class="type">float</span> gz, <span class="type">float</span> ax, <span class="type">float</span> ay, <span class="type">float</span> az)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">float</span> norm;</span><br><span class="line">  <span class="type">float</span> vx, vy, vz;</span><br><span class="line">  <span class="type">float</span> ex, ey, ez;  </span><br><span class="line"> </span><br><span class="line"> <span class="comment">// 测量正常化</span></span><br><span class="line">  norm = <span class="built_in">sqrt</span>(ax*ax + ay*ay + az*az);      </span><br><span class="line">  ax = ax / norm;                   <span class="comment">//单位化</span></span><br><span class="line">  ay = ay / norm;</span><br><span class="line">  az = az / norm;      </span><br><span class="line"> </span><br><span class="line">  <span class="comment">// 估计方向的重力</span></span><br><span class="line">  vx = <span class="number">2</span>*(q1*q3 - q0*q2);</span><br><span class="line">  vy = <span class="number">2</span>*(q0*q1 + q2*q3);</span><br><span class="line">  vz = q0*q0 - q1*q1 - q2*q2 + q3*q3;</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// 错误的领域和方向传感器测量参考方向之间的交叉乘积的总和</span></span><br><span class="line">  ex = (ay*vz - az*vy);</span><br><span class="line">  ey = (az*vx - ax*vz);</span><br><span class="line">  ez = (ax*vy - ay*vx);</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// 积分误差比例积分增益</span></span><br><span class="line">  exInt = exInt + ex*Ki;</span><br><span class="line">  eyInt = eyInt + ey*Ki;</span><br><span class="line">  ezInt = ezInt + ez*Ki;</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// 调整后的陀螺仪测量</span></span><br><span class="line">  gx = gx + Kp*ex + exInt;</span><br><span class="line">  gy = gy + Kp*ey + eyInt;</span><br><span class="line">  gz = gz + Kp*ez + ezInt;</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// 整合四元数率和正常化</span></span><br><span class="line">  q0 = q0 + (-q1*gx - q2*gy - q3*gz)*halfT;</span><br><span class="line">  q1 = q1 + (q0*gx + q2*gz - q3*gy)*halfT;</span><br><span class="line">  q2 = q2 + (q0*gy - q1*gz + q3*gx)*halfT;</span><br><span class="line">  q3 = q3 + (q0*gz + q1*gy - q2*gx)*halfT;  </span><br><span class="line"> </span><br><span class="line">  <span class="comment">// 正常化四元</span></span><br><span class="line">  norm = <span class="built_in">sqrt</span>(q0*q0 + q1*q1 + q2*q2 + q3*q3);</span><br><span class="line">  q0 = q0 / norm;</span><br><span class="line">  q1 = q1 / norm;</span><br><span class="line">  q2 = q2 / norm;</span><br><span class="line">  q3 = q3 / norm;</span><br><span class="line"> </span><br><span class="line">  Pitch = <span class="built_in">asin</span>(<span class="number">-2</span> * q1 * q3 + <span class="number">2</span> * q0* q2)* <span class="number">57.3</span>; <span class="comment">// pitch ,转换为度数</span></span><br><span class="line">  Roll = <span class="built_in">atan2</span>(<span class="number">2</span> * q2 * q3 + <span class="number">2</span> * q0 * q1, <span class="number">-2</span> * q1 * q1 - <span class="number">2</span> * q2* q2 + <span class="number">1</span>)* <span class="number">57.3</span>; <span class="comment">// rollv</span></span><br><span class="line">  <span class="comment">//Yaw = atan2(2*(q1*q2 + q0*q3),q0*q0+q1*q1-q2*q2-q3*q3) * 57.3;                //此处没有价值，注掉</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">float</span> compound_angle = <span class="number">0</span>; <span class="comment">//复合角度</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> timer = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">loop</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">sensors_event_t</span> a, g, temp;</span><br><span class="line">  mpu.<span class="built_in">getEvent</span>(&amp;a, &amp;g, &amp;temp);</span><br><span class="line">  <span class="built_in">IMUupdate</span>(g.gyro.x, g.gyro.y, g.gyro.z, a.acceleration.x, a.acceleration.y, a.acceleration.z);</span><br><span class="line">  compound_angle = <span class="built_in">sqrt</span>( <span class="built_in">pow</span>(Pitch,<span class="number">2</span>) + <span class="built_in">pow</span>(Roll,<span class="number">2</span>) );</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span>(compound_angle &gt;= <span class="number">60</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    myservo.<span class="built_in">write</span>(<span class="number">0</span>);</span><br><span class="line">    Serial.<span class="built_in">println</span>(<span class="string">&quot;111&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span>(compound_angle &lt;= <span class="number">60</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    myservo.<span class="built_in">write</span>(pos);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(<span class="built_in">millis</span>() - timer &gt;= <span class="number">250</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span>(transmittedFlag)</span><br><span class="line">    &#123;</span><br><span class="line">      transmittedFlag = <span class="literal">false</span>;</span><br><span class="line">      radio.<span class="built_in">finishTransmit</span>();</span><br><span class="line">      </span><br><span class="line">      String l = <span class="built_in">String</span>(bmp.<span class="built_in">readAltitude</span>(<span class="number">102000</span>) , <span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">      transmissionState = radio.<span class="built_in">startTransmit</span>(l);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Serial.<span class="built_in">println</span>(<span class="string">&quot;Data sent!   &quot;</span>);</span><br><span class="line">    Serial.<span class="built_in">print</span>(<span class="string">&quot;Altitude= &quot;</span>);</span><br><span class="line">    Serial.<span class="built_in">print</span>(bmp.<span class="built_in">readAltitude</span>(<span class="number">102000</span>));</span><br><span class="line">    Serial.<span class="built_in">println</span>(<span class="string">&quot; meters&quot;</span>);</span><br><span class="line">    Serial.<span class="built_in">print</span>(<span class="string">&quot;Compound angle= &quot;</span>);</span><br><span class="line">    Serial.<span class="built_in">print</span>(compound_angle);</span><br><span class="line">    Serial.<span class="built_in">println</span>(<span class="string">&quot; degrees&quot;</span>);</span><br><span class="line">    Serial.<span class="built_in">println</span>();</span><br><span class="line">    </span><br><span class="line">    timer = <span class="built_in">millis</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p></pre> </details></p>

    </div>

    
    
    

      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/Rocketry/" rel="tag"><i class="fa fa-tag"></i> Rocketry</a>
              <a href="/tags/My-Projects/" rel="tag"><i class="fa fa-tag"></i> My Projects</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2024/04/01/Being-a-Conductor-Rachmaninoff-Piano-Concerto-No-2/" rel="prev" title="Being a Conductor: Rachmaninoff Piano Concerto No.2">
      <i class="fa fa-chevron-left"></i> Being a Conductor: Rachmaninoff Piano Concerto No.2
    </a></div>
      <div class="post-nav-item">
    <a href="/2024/04/30/Being-a-Conductor-Mambo-from-Westside-Story/" rel="next" title="Being a Conductor: Mambo from Westside Story">
      Being a Conductor: Mambo from Westside Story <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Programming"><span class="nav-number">1.</span> <span class="nav-text"> Programming </span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">FOEV</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">8</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        <!--
-->

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">FOEV</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  











<script>
document.querySelectorAll('.pdfobject-container').forEach(element => {
  let url = element.dataset.target;
  let pdfOpenParams = {
    navpanes : 0,
    toolbar  : 0,
    statusbar: 0,
    pagemode : 'thumbs',
    view     : 'FitH'
  };
  let pdfOpenFragment = '#' + Object.entries(pdfOpenParams).map(([key, value]) => `${key}=${encodeURIComponent(value)}`).join('&');
  let fullURL = `/lib/pdf/web/viewer.html?file=${encodeURIComponent(url)}${pdfOpenFragment}`;

  if (NexT.utils.supportsPDFs()) {
    element.innerHTML = `<embed class="pdfobject" src="${url + pdfOpenFragment}" type="application/pdf" style="height: ${element.dataset.height};">`;
  } else {
    element.innerHTML = `<iframe src="${fullURL}" style="height: ${element.dataset.height};" frameborder="0"></iframe>`;
  }
});
</script>




  

  

</body>
</html>
